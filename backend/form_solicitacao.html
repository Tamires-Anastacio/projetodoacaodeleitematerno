<?php
session_start();
require 'conexao.php';

// Verifica login
if (!isset($_SESSION['id_user'])) {
    header("Location: login.php");
    exit;
}

// Busca dados do usuário
$id_user = $_SESSION['id_user'];
$stmt = $conn->prepare("SELECT cidade, uf FROM usuario WHERE id_user = ?");
$stmt->bind_param("i", $id_user); $stmt->execute(); $user =
$stmt->get_result()->fetch_assoc(); $cidade = $user['cidade']; $uf =
$user['uf']; // Busca instituições próximas (mesma cidade e UF) $stmt2 =
$conn->prepare("SELECT id_instituicao, nome FROM instituicao WHERE cidade = ?
AND uf = ?"); $stmt2->bind_param("ss", $cidade, $uf); $stmt2->execute();
$instituicoes = $stmt2->get_result()->fetch_all(MYSQLI_ASSOC); // Envio do
formulário if ($_SERVER["REQUEST_METHOD"] === "POST") { $tipo =
$_POST['tipo_solicitacao']; $observacao = trim($_POST['observacao']);
$id_instituicao = $_POST['id_instituicao']; $stmt3 = $conn->prepare("INSERT INTO
solicitacao (id_user, id_instituicao, tipo_solicitacao, observacao) VALUES (?,
?, ?, ?)"); $stmt3->bind_param("iiss", $id_user, $id_instituicao, $tipo,
$observacao); if ($stmt3->execute()) { echo "
<script>
  alert(
    "Solicitação enviada com sucesso! As instituições próximas foram notificadas."
  );
  window.location.href = "perfil_user.php";
</script>
"; } else { echo "
<script>
  alert("Erro ao enviar a solicitação.");
</script>
"; } } ?>

<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Nova Solicitação</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(135deg, #e7d9ff, #f7f3ff);
        font-family: "Poppins", sans-serif;
      }
      .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        background-color: white;
      }
      .btn-primary {
        background-color: #7b2ff7;
        border: none;
        transition: 0.3s;
      }
      .btn-primary:hover {
        background-color: #5a10c5;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <div class="card p-4 mx-auto" style="max-width: 600px">
        <h2 class="text-center text-primary mb-4">
          Solicitar Doação ou Recebimento
        </h2>

        <form method="POST" action="">
          <!-- Tipo -->
          <div class="mb-3">
            <label class="form-label fw-bold">Tipo de Solicitação:</label><br />
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                name="tipo_solicitacao"
                id="doar"
                value="doar"
                required
              />
              <label class="form-check-label" for="doar"
                >Quero Doar Leite</label
              >
            </div>
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                name="tipo_solicitacao"
                id="receber"
                value="receber"
              />
              <label class="form-check-label" for="receber"
                >Preciso Receber Leite</label
              >
            </div>
          </div>

          <!-- Instituição próxima -->
          <div class="mb-3">
            <label class="form-label fw-bold">Instituição mais próxima:</label>
            <select name="id_instituicao" class="form-select" required>
              <?php if (count($instituicoes) >
              0): ?>
              <?php foreach ($instituicoes as $i): ?>
              <option value="<?= $i['id_instituicao'] ?>">
                <?= htmlspecialchars($i['nome']) ?>
                —
                <?= $cidade ?>/<?= $uf ?>
              </option>
              <?php endforeach; ?>
              <?php else: ?>
              <option disabled>
                Nenhuma instituição encontrada na sua cidade.
              </option>
              <?php endif; ?>
            </select>
          </div>

          <!-- Observações -->
          <div class="mb-3">
            <label class="form-label fw-bold">Observações:</label>
            <textarea
              name="observacao"
              class="form-control"
              rows="3"
              placeholder="Descreva sua situação (ex: 'quero doar semanalmente' ou 'preciso urgente')"
            ></textarea>
          </div>

          <!-- Botão -->
          <div class="text-center">
            <button type="submit" class="btn btn-primary px-5 py-2">
              Enviar Solicitação
            </button>
          </div>
        </form>
      </div>
    </div>
  </body>
</html>
