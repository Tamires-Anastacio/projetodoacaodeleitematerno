<?php
session_start();
require 'conexao.php';

// Verifica se √© admin
if (!isset($_SESSION['tipo_usuario']) || $_SESSION['tipo_usuario'] != 'admin') {
  header("Location: login.php");
  exit;
}

// Consultas
$usuarios = $conn->query("SELECT * FROM usuario ORDER BY id_user DESC");
$instituicoes = $conn->query("SELECT * FROM instituicao ORDER BY id_instituicao
DESC"); ?>

<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Administrativo</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      body {
        background: #f5f4fc;
        font-family: "Poppins", sans-serif;
      }

      .navbar {
        background: linear-gradient(90deg, #5e17eb, #6d3ff7);
        color: white;
      }

      .nav-link.active {
        background-color: #fff !important;
        color: #5e17eb !important;
        border-radius: 10px;
        font-weight: bold;
      }

      .card {
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
      }

      .btn-edit {
        background: #ffc107;
        color: white;
        border: none;
      }

      .btn-delete {
        background: #dc3545;
        color: white;
        border: none;
      }

      .btn-edit:hover,
      .btn-delete:hover {
        opacity: 0.85;
      }

      .modal-header {
        background: #5e17eb;
        color: white;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg px-4 py-3">
      <h3 class="text-white m-0">
        <i class="bi bi-shield-lock"></i> Painel Administrativo
      </h3>
      <div class="ms-auto">
        <a href="logout.php" class="btn btn-light btn-sm">Sair</a>
      </div>
    </nav>

    <div class="container mt-4">
      <!-- Abas -->
      <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item">
          <button
            class="nav-link active"
            id="users-tab"
            data-bs-toggle="tab"
            data-bs-target="#users"
            type="button"
          >
            üë§ Usu√°rios
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            id="instituicoes-tab"
            data-bs-toggle="tab"
            data-bs-target="#instituicoes"
            type="button"
          >
            üè• Institui√ß√µes
          </button>
        </li>
      </ul>

      <div class="tab-content mt-3">
        <!-- Usu√°rios -->
        <div class="tab-pane fade show active" id="users">
          <div class="card p-3">
            <h4 class="mb-3 text-primary">
              <i class="bi bi-people"></i> Lista de Usu√°rios
            </h4>
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Telefone</th>
                    <th>A√ß√µes</th>
                  </tr>
                </thead>
                <tbody>
                  <?php while($u = $usuarios->fetch_assoc()) { ?>
                  <tr>
                    <td><?= $u['id_user'] ?></td>
                    <td><?= htmlspecialchars($u['nome_completo']) ?></td>
                    <td><?= htmlspecialchars($u['email']) ?></td>
                    <td><?= htmlspecialchars($u['telefone']) ?></td>
                    <td>
                      <button
                        class="btn btn-edit btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#editUserModal"
                        data-id="<?= $u['id_user'] ?>"
                        data-nome="<?= htmlspecialchars($u['nome_completo']) ?>"
                        data-email="<?= htmlspecialchars($u['email']) ?>"
                        data-telefone="<?= htmlspecialchars($u['telefone']) ?>"
                        data-cidade="<?= htmlspecialchars($u['cidade']) ?>"
                        data-uf="<?= htmlspecialchars($u['uf']) ?>"
                        data-data_nasc="<?= htmlspecialchars($u['data_nascimento']) ?>"
                        data-tipo="<?= htmlspecialchars($u['tipo_user']) ?>"
                      >
                        <i class="bi bi-pencil-square"></i>
                      </button>
                      <button
                        class="btn btn-delete btn-sm"
                        onclick="confirmDelete('usuario', <?= $u['id_user'] ?>)"
                      >
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                  <?php } ?>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Institui√ß√µes -->
        <div class="tab-pane fade" id="instituicoes">
          <div class="card p-3">
            <h4 class="mb-3 text-primary">
              <i class="bi bi-building"></i> Lista de Institui√ß√µes
            </h4>
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Cidade</th>
                    <th>UF</th>
                    <th>A√ß√µes</th>
                  </tr>
                </thead>
                <tbody>
                  <?php while($i = $instituicoes->fetch_assoc()) { ?>
                  <tr>
                    <td><?= $i['id_instituicao'] ?></td>
                    <td><?= htmlspecialchars($i['nome']) ?></td>
                    <td><?= htmlspecialchars($i['cidade']) ?></td>
                    <td><?= htmlspecialchars($i['uf']) ?></td>
                    <td>
                      <button
                        class="btn btn-edit btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#editInstModal"
                        data-id="<?= $i['id_instituicao'] ?>"
                        data-nome="<?= htmlspecialchars($i['nome']) ?>"
                        data-cidade="<?= htmlspecialchars($i['cidade']) ?>"
                        data-uf="<?= htmlspecialchars($i['uf']) ?>"
                        data-rua="<?= htmlspecialchars($i['rua']) ?>"
                        data-num="<?= htmlspecialchars($i['num']) ?>"
                        data-cert="<?= htmlspecialchars($i['certificacao']) ?>"
                      >
                        <i class="bi bi-pencil-square"></i>
                      </button>
                      <button
                        class="btn btn-delete btn-sm"
                        onclick="confirmDelete('instituicao', <?= $i['id_instituicao'] ?>)"
                      >
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                  <?php } ?>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL EDIT USU√ÅRIO -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Editar Usu√°rio</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form action="edita_user.php" method="POST">
            <div class="modal-body">
              <input type="hidden" name="id_user" id="user_id" />
              <label>Nome</label>
              <input
                type="text"
                class="form-control mb-2"
                name="nome"
                id="user_nome"
              />
              <label>Email</label>
              <input
                type="email"
                class="form-control mb-2"
                name="email"
                id="user_email"
              />
              <label>Telefone</label>
              <input
                type="text"
                class="form-control mb-2"
                name="telefone"
                id="user_telefone"
              />
              <label>Cidade</label>
              <input
                type="text"
                class="form-control mb-2"
                name="cidade"
                id="user_cidade"
              />
              <label>UF</label>
              <input
                type="text"
                class="form-control mb-2"
                name="uf"
                id="user_uf"
                maxlength="2"
              />
              <label>Data de Nascimento</label>
              <input
                type="date"
                class="form-control mb-2"
                id="user_nascimento"
                disabled
              />
              <label>Tipo de Usu√°rio</label>
              <input
                type="text"
                class="form-control mb-2"
                name="tipo_user"
                id="user_tipo"
              />
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">
                Salvar Altera√ß√µes
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- MODAL EDIT INSTITUI√á√ÉO -->
    <div class="modal fade" id="editInstModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Editar Institui√ß√£o</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form action="edita_inst.php" method="POST">
            <div class="modal-body">
              <input type="hidden" name="id_instituicao" id="inst_id" />
              <label>Nome</label>
              <input
                type="text"
                class="form-control mb-2"
                name="nome"
                id="inst_nome"
              />
              <label>Cidade</label>
              <input
                type="text"
                class="form-control mb-2"
                name="cidade"
                id="inst_cidade"
              />
              <label>UF</label>
              <input
                type="text"
                class="form-control mb-2"
                name="uf"
                id="inst_uf"
                maxlength="2"
              />
              <label>Rua</label>
              <input
                type="text"
                class="form-control mb-2"
                name="rua"
                id="inst_rua"
              />
              <label>N√∫mero</label>
              <input
                type="text"
                class="form-control mb-2"
                name="num"
                id="inst_num"
              />
              <label>Certifica√ß√£o</label>
              <textarea
                class="form-control mb-2"
                name="certificacao"
                id="inst_cert"
              ></textarea>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">
                Salvar Altera√ß√µes
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Preenche modal de usu√°rio
      const userModal = document.getElementById("editUserModal");
      userModal.addEventListener("show.bs.modal", (event) => {
        const button = event.relatedTarget;
        document.getElementById("user_id").value =
          button.getAttribute("data-id");
        document.getElementById("user_nome").value =
          button.getAttribute("data-nome");
        document.getElementById("user_email").value =
          button.getAttribute("data-email");
        document.getElementById("user_telefone").value =
          button.getAttribute("data-telefone");
        document.getElementById("user_cidade").value =
          button.getAttribute("data-cidade");
        document.getElementById("user_uf").value =
          button.getAttribute("data-uf");
        document.getElementById("user_nascimento").value =
          button.getAttribute("data-data_nasc");
        document.getElementById("user_tipo").value =
          button.getAttribute("data-tipo");
      });

      // Preenche modal de institui√ß√£o
      const instModal = document.getElementById("editInstModal");
      instModal.addEventListener("show.bs.modal", (event) => {
        const button = event.relatedTarget;
        document.getElementById("inst_id").value =
          button.getAttribute("data-id");
        document.getElementById("inst_nome").value =
          button.getAttribute("data-nome");
        document.getElementById("inst_cidade").value =
          button.getAttribute("data-cidade");
        document.getElementById("inst_uf").value =
          button.getAttribute("data-uf");
        document.getElementById("inst_rua").value =
          button.getAttribute("data-rua");
        document.getElementById("inst_num").value =
          button.getAttribute("data-num");
        document.getElementById("inst_cert").value =
          button.getAttribute("data-cert");
      });

      // SweetAlert exclus√£o
      function confirmDelete(tipo, id) {
        Swal.fire({
          title: "Tem certeza?",
          text: "Essa a√ß√£o n√£o pode ser desfeita!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Sim, apagar",
          cancelButtonText: "Cancelar",
          confirmButtonColor: "#dc3545",
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = `deletar.php?tipo=${tipo}&id=${id}`;
          }
        });
      }
    </script>
  </body>
</html>
