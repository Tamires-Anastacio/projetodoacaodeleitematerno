CREATE DATABASE sistema;
USE sistema;


--  TABELA: USUÁRIO

CREATE TABLE usuario (
    id_user INT AUTO_INCREMENT PRIMARY KEY,
    cpf VARCHAR(14) NOT NULL UNIQUE,
    nome_completo VARCHAR(255) NOT NULL,
    cidade VARCHAR(100) NOT NULL,
    data_nascimento DATE NOT NULL,
    telefone CHAR(15) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    senha_hash VARCHAR(255) NOT NULL,
    uf CHAR(2) NOT NULL,
    tipo_user ENUM('adm','inst','user') NOT NULL DEFAULT 'user',
    data_cadastro DATETIME DEFAULT CURRENT_TIMESTAMP,
    latitude DECIMAL(10,8),
    longitude DECIMAL(11,8)
);


--  TABELA: INSTITUIÇÃO

CREATE TABLE instituicao (
    id_instituicao INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(255) NOT NULL,
    cnpj VARCHAR(18) NOT NULL UNIQUE,
    certificacao TEXT,
    especialidade VARCHAR(100),
    cidade VARCHAR(100) NOT NULL,
    uf CHAR(2) NOT NULL,
    rua VARCHAR(100) NOT NULL,
    num INT NOT NULL,
    telefone CHAR(15),
    email VARCHAR(100),
    tipo_user ENUM('adm','inst','user') NOT NULL DEFAULT 'inst',
    data_cadastro DATETIME DEFAULT CURRENT_TIMESTAMP,
    senha_hash varchar(100)
);


--  TABELA: MENSAGENS

CREATE TABLE mensagem (
    id_mensagem INT AUTO_INCREMENT PRIMARY KEY,
    data_envio DATETIME DEFAULT CURRENT_TIMESTAMP,
    id_remetente INT NOT NULL,
    id_destinatario INT NOT NULL,
    conteudo TEXT NOT NULL,
    FOREIGN KEY (id_remetente) REFERENCES usuario(id_user),
    FOREIGN KEY (id_destinatario) REFERENCES usuario(id_user)
);


--  TABELA: TIPO DE LEITE

CREATE TABLE tipo_leite (
    id_tipo INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    descricao VARCHAR(255) NOT NULL
);


--  TABELA: DOAÇÃO

CREATE TABLE doacao (
    id_doacao INT AUTO_INCREMENT PRIMARY KEY,
    observacao VARCHAR(255),
    status ENUM('pendente','aceita','recusada','finalizada') DEFAULT 'pendente',
    id_doadora INT NOT NULL,
    id_instituicao INT NOT NULL,
    data_doacao DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_doadora) REFERENCES usuario(id_user),
    FOREIGN KEY (id_instituicao) REFERENCES instituicao(id_instituicao)
);


--  RELAÇÃO: DOAÇÃO → TIPO DE LEITE

CREATE TABLE possui (
    id_tipo INT NOT NULL,
    id_doacao INT NOT NULL,
    PRIMARY KEY (id_tipo, id_doacao),
    FOREIGN KEY (id_tipo) REFERENCES tipo_leite(id_tipo),
    FOREIGN KEY (id_doacao) REFERENCES doacao(id_doacao)
);


--  RELAÇÃO: INSTITUIÇÃO RECEBE DOAÇÃO

CREATE TABLE recebe (
    id_instituicao INT NOT NULL,
    id_doacao INT NOT NULL,
    PRIMARY KEY (id_instituicao, id_doacao),
    FOREIGN KEY (id_instituicao) REFERENCES instituicao(id_instituicao),
    FOREIGN KEY (id_doacao) REFERENCES doacao(id_doacao)
);


--  SOLICITAÇÃO (DOAR OU RECEBER)

CREATE TABLE solicitacao (
    id_solicitacao INT AUTO_INCREMENT PRIMARY KEY,
    id_user INT NOT NULL,
    id_instituicao INT NOT NULL,
    tipo_solicitacao ENUM('doar','receber') NOT NULL,
    observacao VARCHAR(255),
    data_solicitacao DATETIME DEFAULT CURRENT_TIMESTAMP,
    status ENUM('pendente','aceita','recusada') DEFAULT 'pendente',
    FOREIGN KEY (id_user) REFERENCES usuario(id_user),
    FOREIGN KEY (id_instituicao) REFERENCES instituicao(id_instituicao)
);
