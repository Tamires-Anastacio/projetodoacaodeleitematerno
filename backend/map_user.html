<?php
session_start();
require_once "conexao.php";

// üîí Verifica se o usu√°rio est√° logado
if (!isset($_SESSION['id_user'])) {
  header("Location: login.php");
  exit;
}

// üîé Busca cidade e UF do usu√°rio logado
$id_user = $_SESSION['id_user'];
$sql = $pdo->prepare("SELECT nome_completo, cidade, uf FROM usuario WHERE
id_user = ?"); $sql->execute([$id_user]); $user = $sql->fetch(PDO::FETCH_ASSOC);
if (!$user) { die("Usu√°rio n√£o encontrado."); } $cidade = $user['cidade']; $uf =
$user['uf']; ?>

<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Institui√ß√µes Pr√≥ximas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f6f4f7;
        padding: 20px;
      }
      #map {
        height: 500px;
        width: 100%;
        border-radius: 10px;
        margin-top: 20px;
      }
      h2 {
        color: #5e17eb;
      }
      #lista {
        margin-top: 20px;
        background-color: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .item {
        border-bottom: 1px solid #eee;
        padding: 10px 0;
      }
      .item:last-child {
        border-bottom: none;
      }
      .cad {
        color: #5e17eb;
        font-weight: bold;
      }
      .nao-cad {
        color: #007bff;
      }
      a {
        color: #007bff;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <h2>
      üè• Institui√ß√µes pr√≥ximas de
      <?= htmlspecialchars($cidade) ?>/<?= htmlspecialchars($uf) ?>
    </h2>
    <div id="map"></div>
    <div id="lista"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
            const cidade = "<?= htmlspecialchars($cidade) ?>";
            const uf = "<?= htmlspecialchars($uf) ?>";
            let map = L.map("map").setView([-14.235, -51.9253], 4);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
              attribution: "&copy; OpenStreetMap",
            }).addTo(map);

            let markersLayer = L.layerGroup().addTo(map);

            async function buscarInstituicoes() {
              const listaDiv = document.getElementById("lista");
              listaDiv.innerHTML = "<p>üîç Buscando institui√ß√µes pr√≥ximas...</p>";

              // üîπ Busca institui√ß√µes cadastradas no banco
              const resp = await fetch(
                `buscar_instituicoes.php?cidade=${cidade}&uf=${uf}`
              );
              const dados = await resp.json();

              markersLayer.clearLayers();
              listaDiv.innerHTML = "";

              if (dados.length === 0) {
                listaDiv.innerHTML = `
                <p>Nenhuma institui√ß√£o cadastrada encontrada em <b>${cidade}/${uf}</b>.</p>
                <div class="item nao-cad">
                  <b>üîó Outras institui√ß√µes pr√≥ximas</b><br>
                  <a href="https://www.google.com/maps/search/banco+de+leite+${cidade}+${uf}" target="_blank">
                    Ver bancos de leite e hospitais em ${cidade} no Google Maps
                  </a>
                </div>
              `;
                return;
              }

              // üîπ Adiciona pinos e lista
              data.forEach(p => {
        const iconColor = p.origem === 'google' ? 'blue' : 'purple';

        const customIcon = L.icon({
          iconUrl: `https://maps.google.com/mapfiles/ms/icons/${iconColor}-dot.png`,
          iconSize: [32, 32],
          iconAnchor: [16, 32]
        });

        L.marker([p.latitude, p.longitude], { icon: customIcon })
          .bindPopup(`
            <b>${p.nome}</b><br>
            ${p.rua ? `${p.rua}, ${p.num}<br>` : ""}
            ${p.cidade}/${p.uf}<br>
            ${p.origem === 'google' ? `<a href="https://www.google.com/search?q=${encodeURIComponent(p.nome + ' ' + p.cidade)}" target="_blank">Ver no Google üîó</a>` : ""}
          `)
          .addTo(markersLayer);
      });
    </script>
  </body>
</html>
