<?php
session_start();
require "../backend/includes/conexao.php";

if (!isset($_SESSION['id_user'])) {
    header("Location: form_login.html"); exit;
}

$id_user = $_SESSION['id_user'];
$sql = $pdo->prepare("SELECT nome_completo, cidade, uf FROM usuario WHERE id_user = ?");
$sql->execute([$id_user]);
$user = $sql->fetch(PDO::FETCH_ASSOC);
if (!$user) die("Usu√°rio n√£o encontrado.");

$cidade = htmlspecialchars($user['cidade']);
$uf = htmlspecialchars($user['uf']);
?>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Institui√ß√µes Pr√≥ximas</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  body { font-family: Arial,sans-serif; background:#f6f4f7; padding:20px; }
  #map { height:500px; width:100%; border-radius:10px; margin-top:20px; }
  #lista { margin-top:20px; background:#fff; border-radius:8px; padding:15px; box-shadow:0 2px 4px rgba(0,0,0,0.1); max-height:300px; overflow-y:auto; }
  .item { border-bottom:1px solid #eee; padding:10px 0; cursor:pointer; }
  .item:last-child { border-bottom:none; }
  .cad { color:purple; font-weight:bold; }
  .nao-cad { color:blue; font-weight:bold; }
</style>
</head>
<body>

<h2>üè• Institui√ß√µes pr√≥ximas de <?= $cidade ?>/<?= $uf ?></h2>
<div id="map"></div>
<div id="lista"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const cidade = "<?= $cidade ?>";
const uf = "<?= $uf ?>";

let map = L.map('map').setView([-14.235, -51.9253], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; OpenStreetMap'
}).addTo(map);

let markersLayer = L.layerGroup().addTo(map);
let listaDiv = document.getElementById("lista");
let bounds = [];

function addMarker(inst){
    const color = inst.origem==='banco'?'purple':'blue';
    const icon = L.icon({
        iconUrl: `https://maps.google.com/mapfiles/ms/icons/${color}-dot.png`,
        iconSize:[32,32], iconAnchor:[16,32]
    });
    const marker = L.marker([inst.latitude, inst.longitude], {icon})
        .bindPopup(`<b>${inst.nome}</b><br>${inst.rua?inst.rua+', '+inst.num+'<br>':''}${inst.cidade}/${inst.uf}<br>Certifica√ß√£o: ${inst.certificacao||'N√£o informada'}`)
        .addTo(markersLayer);

    bounds.push([inst.latitude, inst.longitude]);

    const divItem = document.createElement("div");
    divItem.className = "item " + (inst.origem==='banco'?'cad':'nao-cad');
    divItem.innerHTML = `<b>${inst.nome}</b> - ${inst.rua?inst.rua+', ':''}${inst.cidade}/${inst.uf}`;
    divItem.addEventListener("click", ()=>{
        map.setView([inst.latitude, inst.longitude],16);
        marker.openPopup();
    });
    listaDiv.appendChild(divItem);
}

// Buscar cadastradas
fetch(`../backend/buscar.php?cidade=${cidade}&uf=${uf}`)
    .then(res => res.json())
    .then(data => {
        console.log(data); // para testar
    })
    .catch(err => console.error(err));;
</script>

</body>
</html>
